<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bareca at Bike and Boot Enquiry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        .save-indicator { font-size: 0.8rem; }
        input:focus, select:focus, textarea:focus { border-color: #2563eb; }
        input[readonly] { background-color: #f8fafc; color: #64748b; cursor: not-allowed; }
        .loading-shimmer { opacity: 0.5; pointer-events: none; }
        .error-shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <div class="max-w-3xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="bg-white rounded-t-xl shadow-sm border-b p-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Bareca at Bike and Boot</h1>
                    <p class="text-slate-500 text-sm">Enquiry Form</p>
                </div>
                <div id="authStatus" class="text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full italic">Initialising...</div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="bg-white p-6 shadow-sm">
            <form id="reservationForm" class="space-y-6 loading-shimmer">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Customer Name -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Customer Name</label>
                        <input type="text" name="customerName" placeholder="Full Name" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Customer Email -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Customer Email</label>
                        <input type="email" name="customerEmail" placeholder="email@example.com" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Phone Number (+44) -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Phone Number</label>
                        <input type="tel" name="customerPhone" placeholder="+44 7..." class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Reservation Date -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Reservation Date</label>
                        <input type="date" name="resDate" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Reservation Time -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Reservation Time</label>
                        <input type="time" name="resTime" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Menu Arrangements -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Menu Arrangements</label>
                        <select id="menuArrangement" name="menuArrangement" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                            <option value="Sharing Menu">Sharing Menu</option>
                            <option value="Choose on the Day">Choose on the Day</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Guest Split: Adults -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Adults</label>
                        <input type="number" name="adultCount" min="1" placeholder="Number of Adults" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <!-- Guest Split: Children -->
                    <div>
                        <label class="block text-sm font-semibold mb-1">Children</label>
                        <input type="number" name="childCount" min="0" placeholder="Number of Children" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <!-- Conditional "Other" details -->
                <div id="otherDetailsWrapper" class="hidden">
                    <label class="block text-sm font-semibold mb-1 text-blue-600">Please Specify Other Arrangement</label>
                    <input type="text" name="menuOtherDetails" placeholder="Details..." class="w-full p-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none transition bg-blue-50/30">
                </div>

                <!-- Special Requests -->
                <div>
                    <label class="block text-sm font-semibold mb-1">Special Requests / Allergies</label>
                    <textarea name="notes" rows="3" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition"></textarea>
                </div>

                <!-- Logger Section: Taken By -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t bg-slate-50/50 p-4 rounded-lg">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Enquiry Taken By</label>
                        <input type="text" id="takenBy" name="takenBy" placeholder="Staff Name" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition bg-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Taken On (Auto)</label>
                        <input type="text" id="takenAt" name="takenAt" readonly placeholder="Auto-filled on entry" class="w-full p-3 rounded-lg border border-slate-200 outline-none transition">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t">
                    <button type="button" id="openEmailClientBtn" class="flex-1 bg-blue-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-700 transition shadow-lg flex flex-col items-center justify-center">
                        <span class="text-lg">Open Email Client</span>
                        <span class="text-[10px] opacity-80 uppercase tracking-wider">Drafts Email + Downloads Calendar</span>
                    </button>
                    <button type="button" id="clearFormBtn" class="bg-slate-100 text-slate-500 font-semibold py-4 px-6 rounded-lg hover:bg-red-50 hover:text-red-500 transition">
                        Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Feedback UI -->
        <div class="bg-white rounded-b-xl border-t p-4 flex justify-between items-center text-slate-400">
            <span id="saveStatus" class="save-indicator italic text-xs">Awaiting connection...</span>
            <span id="userIdDisplay" class="text-[10px] uppercase tracking-widest font-bold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const TEAM_EMAILS = "reservations@yourrestaurant.com";

        // Your provided Firebase Configuration
        const userConfig = {
            apiKey: "AIzaSyBLcirFG0rRW-d9sPOw12kvnWKGS5vtoQo",
            authDomain: "bareca-enquiry-form.firebaseapp.com",
            projectId: "bareca-enquiry-form",
            storageBucket: "bareca-enquiry-form.firebasestorage.app",
            messagingSenderId: "124741472331",
            appId: "1:124741472331:web:28ab8255a2f4c549173dce"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bareca-enquiry-v1';

        let currentUser = null;
        let saveTimeout = null;
        let isRestoring = true; // Block saving while we are downloading data

        const form = document.getElementById('reservationForm');
        const saveStatus = document.getElementById('saveStatus');
        const authStatus = document.getElementById('authStatus');
        const menuSelect = document.getElementById('menuArrangement');
        const otherWrapper = document.getElementById('otherDetailsWrapper');
        const takenByInput = document.getElementById('takenBy');
        const takenAtInput = document.getElementById('takenAt');

        // UI Handlers
        menuSelect.addEventListener('change', () => {
            otherWrapper.classList.toggle('hidden', menuSelect.value !== 'Other');
        });

        takenByInput.addEventListener('input', () => {
            if (takenByInput.value.trim() !== "" && !takenAtInput.value) {
                takenAtInput.value = new Date().toLocaleString('en-GB', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else if (takenByInput.value.trim() === "") {
                takenAtInput.value = "";
            }
        });

        // Initialize Authentication
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                authStatus.textContent = "Error: Check Console";
                authStatus.classList.replace('text-blue-600', 'text-red-600');
            }
        };

        // Watch Auth State
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authStatus.textContent = "â— Synced Online";
                authStatus.classList.replace('text-blue-600', 'text-green-600');
                document.getElementById('userIdDisplay').textContent = `ID: ${user.uid.substring(0, 8)}`;
                
                await loadDraft();
                isRestoring = false; 
                form.classList.remove('loading-shimmer');
            }
        });

        const loadDraft = async () => {
            if (!currentUser) return;
            try {
                const draftRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current_enquiry');
                const snap = await getDoc(draftRef);
                if (snap.exists()) {
                    const data = snap.data();
                    Object.keys(data).forEach(key => { 
                        if (form.elements[key]) form.elements[key].value = data[key]; 
                    });
                    menuSelect.dispatchEvent(new Event('change'));
                    saveStatus.textContent = "Previous draft restored successfully.";
                } else {
                    saveStatus.textContent = "New form ready.";
                }
            } catch (e) {
                console.error("Load Error:", e);
                saveStatus.textContent = "Firestore Blocked. Check Rules.";
            }
        };

        const saveDraft = async () => {
            // CRITICAL: Do not save if we haven't authenticated or if we are still restoring old data
            if (!currentUser || isRestoring) return;

            saveStatus.textContent = "Syncing...";
            saveStatus.classList.remove('text-red-600');

            const data = Object.fromEntries(new FormData(form).entries());
            data.lastUpdated = new Date().toISOString();

            try {
                const draftRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current_enquiry');
                await setDoc(draftRef, data);
                saveStatus.textContent = "Auto-saved to cloud.";
            } catch (e) { 
                console.error("Save Error:", e);
                saveStatus.textContent = "Error saving. Check Internet/Permissions."; 
                saveStatus.classList.add('text-red-600');
                saveStatus.classList.add('error-shake');
                setTimeout(() => saveStatus.classList.remove('error-shake'), 500);
            }
        };

        form.addEventListener('input', () => {
            if (isRestoring) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        });

        initAuth();

        // ICS & Email Logic
        const downloadICS = (data) => {
            if (!data.resDate || !data.resTime) return;
            const start = `${data.resDate.replace(/-/g, '')}T${data.resTime.replace(/:/g, '')}00`;
            const totalPax = (parseInt(data.adultCount) || 0) + (parseInt(data.childCount) || 0);
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Bareca Res: ${data.customerName} (${totalPax} Pax)\nDTSTART:${start}\nDESCRIPTION:Phone: ${data.customerPhone}\\nEmail: ${data.customerEmail}\\nMenu: ${data.menuArrangement}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Bareca-Res-${data.customerName.replace(/\s+/g, '-')}.ics`;
            a.click();
            URL.revokeObjectURL(url);
        };

        document.getElementById('openEmailClientBtn').onclick = () => {
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.customerName || !data.resDate || !data.resTime) {
                alert("Please fill in Name, Date, and Time first.");
                return;
            }
            downloadICS(data);
            const totalPax = (parseInt(data.adultCount) || 0) + (parseInt(data.childCount) || 0);
            const arrangement = data.menuArrangement === 'Other' ? `Other (${data.menuOtherDetails})` : data.menuArrangement;
            const subject = encodeURIComponent(`BARECA ENQUIRY: ${data.customerName} - ${data.resDate} (${totalPax} pax)`);
            const body = encodeURIComponent(
                `RESERVATION DETAILS\n------------------\nCustomer Name: ${data.customerName}\nCustomer Email: ${data.customerEmail || 'Not provided'}\nPhone Number: ${data.customerPhone}\n\nDate: ${data.resDate}\nTime: ${data.resTime}\nGuests: ${totalPax} (Adults: ${data.adultCount || 0}, Children: ${data.childCount || 0})\nMenu Arrangement: ${arrangement}\n\nSpecial Requests:\n${data.notes || 'None'}\n\n------------------\nEnquiry Taken By: ${data.takenBy || 'N/A'}\nTaken On: ${data.takenAt || 'N/A'}\n------------------\n\n[Calendar file downloaded - please attach to this email]`
            );
            window.location.href = `mailto:${TEAM_EMAILS}?subject=${subject}&body=${body}`;
        };

        document.getElementById('clearFormBtn').onclick = async () => {
            if (confirm("Reset form? This will permanently delete your cloud draft.")) {
                form.reset();
                otherWrapper.classList.add('hidden');
                if (currentUser) {
                    const draftRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current_enquiry');
                    await deleteDoc(draftRef).catch(() => {});
                }
                saveStatus.textContent = "Form cleared.";
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Enquiry Portal - Bareca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        .loading-shimmer { opacity: 0.5; pointer-events: none; }
        .hidden { display: none; }
        input:focus, select:focus, textarea:focus { border-color: #2563eb; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .syncing-pulse { animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans">

    <!-- LOGIN SCREEN -->
    <div id="loginSection" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-slate-900">Bareca Portal</h1>
                <p class="text-slate-500">Sign in to access enquiry form</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Email</label>
                    <input type="email" id="loginEmail" required class="w-full p-3 rounded-lg border border-slate-200 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Password</label>
                    <input type="password" id="loginPassword" required class="w-full p-3 rounded-lg border border-slate-200 outline-none">
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition shadow-lg">
                    Login
                </button>
                <div id="loginError" class="text-red-500 text-xs text-center mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="appSection" class="max-w-3xl mx-auto py-8 px-4 hidden">
        <div class="bg-white rounded-t-xl shadow-sm border-b p-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Bareca at Bike and Boot</h1>
                <p class="text-slate-500 text-sm">Enquiry Form</p>
            </div>
            <div class="flex flex-col items-end">
                <button id="logoutBtn" class="text-xs text-slate-400 hover:text-red-500 font-bold uppercase tracking-wider mb-2">Logout</button>
                <div id="authStatus" class="text-[10px] font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full uppercase tracking-widest">● Securely Connected</div>
            </div>
        </div>

        <div class="bg-white p-6 shadow-sm">
            <form id="reservationForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Customer Name</label>
                        <input type="text" name="customerName" placeholder="Full Name" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Customer Email</label>
                        <input type="email" name="customerEmail" placeholder="email@example.com" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Phone Number</label>
                        <input type="tel" name="customerPhone" placeholder="+44 7..." class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Reservation Date</label>
                        <input type="date" name="resDate" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Reservation Time</label>
                        <input type="time" name="resTime" required class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Menu Arrangements</label>
                        <select id="menuArrangement" name="menuArrangement" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                            <option value="Sharing Menu">Sharing Menu</option>
                            <option value="Choose on the Day">Choose on the Day</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Adults</label>
                        <input type="number" name="adultCount" min="1" placeholder="0" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Children</label>
                        <input type="number" name="childCount" min="0" placeholder="0" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <div id="otherDetailsWrapper" class="hidden">
                    <label class="block text-sm font-semibold mb-1 text-blue-600">Please Specify Other Arrangement</label>
                    <input type="text" name="menuOtherDetails" placeholder="Details..." class="w-full p-3 rounded-lg border border-blue-200 outline-none transition bg-blue-50/30">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-1">Special Requests / Allergies</label>
                    <textarea name="notes" rows="3" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t bg-slate-50/50 p-4 rounded-lg">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Enquiry Taken By</label>
                        <input type="text" id="takenBy" name="takenBy" placeholder="Staff Name" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition bg-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Taken On (Auto)</label>
                        <input type="text" id="takenAt" name="takenAt" readonly placeholder="Auto-filled on entry" class="w-full p-3 rounded-lg border border-slate-200 outline-none transition bg-slate-100">
                    </div>
                </div>

                <div class="flex flex-col gap-3 pt-4 border-t">
                    <button type="button" id="sendCloudEmailBtn" class="w-full bg-emerald-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-emerald-700 transition shadow-lg flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                        Send to Reservation Team (Cloud)
                    </button>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" id="openEmailClientBtn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 text-sm">
                            Open Local Client
                        </button>
                        <button type="button" id="clearFormBtn" class="bg-slate-100 text-slate-500 font-semibold py-3 px-6 rounded-lg hover:bg-red-50 hover:text-red-500 transition text-sm">
                            Reset Form
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Recent Bookings Dashboard -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-slate-900 mb-4 px-2">Upcoming Reservations</h2>
            <div id="bookingsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div id="noBookings" class="col-span-full p-8 text-center bg-white rounded-xl border border-dashed border-slate-300 text-slate-400 italic">
                    No upcoming reservations found.
                </div>
            </div>
        </div>

        <div class="bg-white mt-8 rounded-xl border-t p-4 flex justify-between items-center text-slate-400">
            <span id="saveStatus" class="save-indicator italic text-xs">Waiting for sync...</span>
            <span id="userIdDisplay" class="text-[10px] uppercase tracking-widest font-bold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLcirFG0rRW-d9sPOw12kvnWKGS5vtoQo",
            authDomain: "bareca-enquiry-form.firebaseapp.com",
            projectId: "bareca-enquiry-form",
            storageBucket: "bareca-enquiry-form.firebasestorage.app",
            messagingSenderId: "124741472331",
            appId: "1:124741472331:web:28ab8255a2f4c549173dce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'bareca-enquiry-v1';
        const TEAM_EMAILS = "stokes.ciaran@gmail.com";

        let currentUser = null;
        let saveTimeout = null;
        let isRestoring = true;

        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const reservationForm = document.getElementById('reservationForm');
        const saveStatus = document.getElementById('saveStatus');
        const menuSelect = document.getElementById('menuArrangement');
        const otherWrapper = document.getElementById('otherDetailsWrapper');
        const takenByInput = document.getElementById('takenBy');
        const takenAtInput = document.getElementById('takenAt');
        const bookingsList = document.getElementById('bookingsList');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                document.getElementById('userIdDisplay').textContent = `Staff ID: ${user.uid.substring(0, 8)}`;
                await loadDraft();
                setupBookingsListener();
                isRestoring = false;
            } else {
                currentUser = null;
                appSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
        });

        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.textContent = "Verifying...";
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
            } catch (err) {
                document.getElementById('loginError').textContent = "Invalid credentials.";
                document.getElementById('loginError').classList.remove('hidden');
            } finally {
                btn.disabled = false; btn.textContent = "Login";
            }
        };

        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        const setupBookingsListener = () => {
            const bookingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'confirmed_bookings');
            onSnapshot(bookingsRef, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
                bookings.sort((a, b) => new Date(`${a.resDate}T${a.resTime}`) - new Date(`${b.resDate}T${b.resTime}`));
                renderBookings(bookings);
            });
        };

        const renderBookings = (bookings) => {
            if (bookings.length === 0) {
                bookingsList.innerHTML = '<div class="col-span-full p-8 text-center bg-white rounded-xl border border-dashed border-slate-300 text-slate-400 italic">No upcoming reservations.</div>';
                return;
            }
            bookingsList.innerHTML = '';
            bookings.forEach(booking => {
                const [y, m, d] = booking.resDate.split('-');
                const tile = document.createElement('div');
                tile.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:border-blue-300 transition-colors relative group";
                tile.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${d}/${m}/${y.slice(-2)}</span>
                        <span class="text-xs font-medium text-slate-400">${booking.resTime}</span>
                    </div>
                    <h3 class="font-bold text-slate-900 mb-1 truncate">${booking.customerName}</h3>
                    <p class="text-xs text-slate-500 mb-3">${(parseInt(booking.adultCount)||0) + (parseInt(booking.childCount)||0)} PAX • ${booking.menuArrangement}</p>
                    <button onclick="cancelBooking('${booking.id}')" class="w-full bg-red-50 text-red-600 text-[10px] font-bold py-2 rounded hover:bg-red-600 hover:text-white transition-all uppercase">Cancel Group</button>
                `;
                bookingsList.appendChild(tile);
            });
        };

        window.cancelBooking = async (bookingId) => {
            if (!confirm("Confirm cancellation? Team will be notified via cloud email.")) return;
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'confirmed_bookings', bookingId));
                if (snap.exists()) {
                    const data = snap.data();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mail'), {
                        to: TEAM_EMAILS,
                        message: {
                            subject: `CANCELLED: BARECA ENQUIRY - ${data.customerName}`,
                            text: `CANCELLATION NOTICE\nGroup: ${data.customerName}\nDate: ${data.resDate}\nTime: ${data.resTime}\n\nCancelled by: ${currentUser.email}`
                        }
                    });
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'confirmed_bookings', bookingId));
                }
            } catch (e) { alert("Cancellation error."); }
        };

        const saveDraft = async () => {
            if (!currentUser || isRestoring) return;
            const data = Object.fromEntries(new FormData(reservationForm).entries());
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current'), data).catch(() => {});
            saveStatus.textContent = "Synced to cloud.";
        };

        const loadDraft = async () => {
            const snap = await getDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'drafts', 'current')).catch(() => {});
            if (snap && snap.exists()) {
                const data = snap.data();
                Object.keys(data).forEach(k => { if(reservationForm.elements[k]) reservationForm.elements[k].value = data[k]; });
                menuSelect.dispatchEvent(new Event('change'));
            }
        };

        reservationForm.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        });

        menuSelect.addEventListener('change', () => otherWrapper.classList.toggle('hidden', menuSelect.value !== 'Other'));
        takenByInput.addEventListener('input', () => {
            if (takenByInput.value.trim() && !takenAtInput.value) {
                takenAtInput.value = new Date().toLocaleString('en-GB', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
            }
        });

        const getExportData = () => {
            const data = Object.fromEntries(new FormData(reservationForm).entries());
            const [y, m, d] = data.resDate.split('-');
            const pax = (parseInt(data.adultCount)||0) + (parseInt(data.childCount)||0);
            return {
                raw: data,
                subject: `BARECA ENQUIRY: ${data.customerName.split(' ').pop()} ${data.customerName[0]} ${d}/${m}/${y.slice(-2)} (${pax} PAX)`,
                body: `CUSTOMER: ${data.customerName}\nPHONE: ${data.customerPhone}\nDATE: ${d}-${m}-${y}\nTIME: ${data.resTime}\nPAX: ${pax}\nMENU: ${data.menuArrangement}\nNOTES: ${data.notes}\n\nTAKEN BY: ${data.takenBy}`
            };
        };

        document.getElementById('sendCloudEmailBtn').onclick = async () => {
            const exp = getExportData();
            if (!reservationForm.elements.customerName.value || !reservationForm.elements.resDate.value) { alert("Missing fields."); return; }
            const btn = document.getElementById('sendCloudEmailBtn');
            btn.disabled = true; btn.classList.add('syncing-pulse');
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mail'), {
                    to: TEAM_EMAILS,
                    message: { subject: exp.subject, text: exp.body }
                });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'confirmed_bookings'), { ...exp.raw });
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current'));
                alert("Confirmed!");
                reservationForm.reset();
                otherWrapper.classList.add('hidden');
            } catch (e) { alert("Permission Error."); }
            finally { btn.disabled = false; btn.classList.remove('syncing-pulse'); }
        };

        document.getElementById('openEmailClientBtn').onclick = () => {
            const exp = getExportData();
            window.location.href = `mailto:${TEAM_EMAILS}?subject=${encodeURIComponent(exp.subject)}&body=${encodeURIComponent(exp.body)}`;
        };

        document.getElementById('clearFormBtn').onclick = async () => {
            if (confirm("Reset form?")) {
                reservationForm.reset();
                if (currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'drafts', 'current'));
            }
        };
    </script>
</body>
</html>

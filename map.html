<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derbyshire Quiz Map Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .map-container {
            cursor: crosshair;
        }

        .pin-dot {
            transform: translate(-50%, -50%);
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        .label-bubble {
            transform: translate(-50%, -50%);
            cursor: grab;
            transition: transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .label-bubble:active {
            cursor: grabbing;
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white;
                color: black;
            }
            .map-wrapper {
                border: none !important;
                height: auto !important;
                width: 100% !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 p-4 shadow-sm z-10 no-print flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fas fa-map-marked-alt text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">Derbyshire Quiz Maker</h1>
                <p class="text-xs text-gray-500">Upload map, click to place pins, drag letters to adjust</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i class="fas fa-print"></i> Print Quiz
            </button>
            <button onclick="app.toggleAnswerSheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i class="fas fa-list-ol"></i> View Answer Key
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Controls -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shadow-lg z-10 no-print">
            <div class="p-4 border-b border-gray-100 space-y-4">
                
                <!-- Image Upload -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">1. Map Source</label>
                    <div class="relative">
                        <input type="file" id="mapUpload" accept="image/*" class="hidden" onchange="app.handleImageUpload(this)">
                        <label for="mapUpload" class="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors group">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-gray-400 group-hover:text-blue-500 mb-1 text-xl"></i>
                                <span class="block text-sm text-gray-600 font-medium">Upload Outline Image</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Input -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">2. Add Location</label>
                    <div class="flex gap-2">
                        <input type="text" id="locationInput" placeholder="e.g. Buxton" 
                            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') document.getElementById('addBtn').click()">
                        <button id="addBtn" onclick="app.preparePin()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <p id="instructionText" class="text-xs text-orange-600 mt-2 hidden animate-pulse">
                        <i class="fas fa-bullseye mr-1"></i> Click on the map to place <strong><span id="nextPinName"></span></strong>
                    </p>
                </div>
            </div>

            <!-- List of Pins -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-gray-700">Locations (<span id="pinCount">0</span>)</h3>
                    <button onclick="app.clearAll()" class="text-xs text-red-500 hover:text-red-700">Clear All</button>
                </div>
                <ul id="locationList" class="space-y-2">
                    <!-- List items generated here -->
                </ul>
                
                <div id="emptyState" class="text-center py-8 text-gray-400">
                    <i class="fas fa-map-pin text-3xl mb-2 opacity-50"></i>
                    <p class="text-sm">No locations added yet.</p>
                </div>
            </div>
        </aside>

        <!-- Main Canvas Area -->
        <main class="flex-1 bg-gray-100 relative overflow-auto flex items-center justify-center p-8 map-wrapper">
            
            <!-- Map Container -->
            <div id="mapContainer" class="relative bg-white shadow-2xl rounded-sm overflow-hidden select-none" 
                 style="min-width: 600px; min-height: 400px; width: 800px; height: 600px;">
                
                <!-- The Map Image -->
                <img id="mapImage" src="" class="absolute inset-0 w-full h-full object-contain pointer-events-none opacity-20" alt="Map Outline">
                
                <!-- SVG Layer for connection lines -->
                <svg id="connectionLayer" class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 1;">
                    <!-- Lines generated here -->
                </svg>

                <!-- Click Area (Overlay) -->
                <div id="clickLayer" class="absolute inset-0 z-10 cursor-crosshair" onclick="app.handleMapClick(event)"></div>

                <!-- Pins and Labels Container -->
                <div id="pinsLayer" class="absolute inset-0 pointer-events-none" style="z-index: 2;">
                    <!-- Pins and Labels generated here -->
                </div>

                <!-- Placeholder Text -->
                <div id="placeholderText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-gray-400">
                    <i class="fas fa-image text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">Upload your Derbyshire map outline</p>
                    <p class="text-sm">to get started</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Answer Sheet Modal -->
    <div id="answerSheetModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Quiz Answer Key</h2>
                <button onclick="app.toggleAnswerSheet()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-8 overflow-y-auto flex-1">
                <div class="grid grid-cols-2 gap-x-8 gap-y-4" id="answerSheetContent">
                    <!-- Answers generated here -->
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="app.printAnswerKey()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    <i class="fas fa-print mr-2"></i> Print Key
                </button>
                <button onclick="app.toggleAnswerSheet()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Printable Answer Sheet (Hidden unless printing) -->
    <div class="hidden print-only p-8">
        <h1 class="text-3xl font-bold mb-8 text-center border-b-2 border-black pb-4">Quiz Answer Sheet</h1>
        <div class="grid grid-cols-2 gap-8" id="printableAnswerLines">
            <!-- Lines for guests to write on -->
        </div>
    </div>

    <script>
        const app = {
            locations: [],
            isPlacing: false,
            pendingName: '',
            nextId: 1,
            draggedLabel: null,
            mapDimensions: { width: 800, height: 600 }, // Default

            init() {
                this.updateUI();
                
                // Add window resize listener to update SVG lines if needed
                // Add global mouse up for dragging
                document.addEventListener('mousemove', (e) => this.handleDrag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
            },

            handleImageUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('mapImage');
                        img.src = e.target.result;
                        img.classList.remove('opacity-20');
                        img.classList.add('opacity-100');
                        document.getElementById('placeholderText').classList.add('hidden');
                        
                        // Adjust container aspect ratio
                        const tempImg = new Image();
                        tempImg.src = e.target.result;
                        tempImg.onload = () => {
                            const aspect = tempImg.width / tempImg.height;
                            const container = document.getElementById('mapContainer');
                            // Max width 800, Max height 600
                            if (aspect > 1) {
                                container.style.width = '800px';
                                container.style.height = (800 / aspect) + 'px';
                            } else {
                                container.style.height = '600px';
                                container.style.width = (600 * aspect) + 'px';
                            }
                            this.mapDimensions = {
                                width: container.clientWidth,
                                height: container.clientHeight
                            };
                        }
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            preparePin() {
                const input = document.getElementById('locationInput');
                const name = input.value.trim();
                if (!name) return alert('Please enter a location name first.');
                
                this.isPlacing = true;
                this.pendingName = name;
                
                document.getElementById('locationInput').disabled = true;
                document.getElementById('instructionText').classList.remove('hidden');
                document.getElementById('nextPinName').textContent = name;
                document.getElementById('mapContainer').classList.add('cursor-crosshair');
            },

            handleMapClick(e) {
                if (!this.isPlacing) return;

                const rect = e.target.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Create pin data
                // Default label position is up and right by 40px
                const pin = {
                    id: this.nextId++,
                    letter: this.getLetter(this.locations.length),
                    name: this.pendingName,
                    pinX: x,
                    pinY: y,
                    labelX: x + 40, 
                    labelY: y - 40 
                };

                this.locations.push(pin);
                
                // Reset State
                this.isPlacing = false;
                this.pendingName = '';
                document.getElementById('locationInput').value = '';
                document.getElementById('locationInput').disabled = false;
                document.getElementById('locationInput').focus();
                document.getElementById('instructionText').classList.add('hidden');
                document.getElementById('mapContainer').classList.remove('cursor-crosshair');

                this.renderMapItems();
                this.updateList();
            },

            renderMapItems() {
                const pinsLayer = document.getElementById('pinsLayer');
                const connectionLayer = document.getElementById('connectionLayer');
                
                pinsLayer.innerHTML = '';
                connectionLayer.innerHTML = '';

                this.locations.forEach(loc => {
                    // 1. Draw SVG Line
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', loc.pinX);
                    line.setAttribute('y1', loc.pinY);
                    line.setAttribute('x2', loc.labelX);
                    line.setAttribute('y2', loc.labelY);
                    line.setAttribute('stroke', '#000');
                    line.setAttribute('stroke-width', '2');
                    connectionLayer.appendChild(line);

                    // 2. Draw Pin Dot
                    const pinDot = document.createElement('div');
                    pinDot.className = 'absolute w-3 h-3 bg-red-600 rounded-full border-2 border-white shadow-sm pin-dot pointer-events-auto';
                    pinDot.style.left = loc.pinX + 'px';
                    pinDot.style.top = loc.pinY + 'px';
                    // Optional: tooltip
                    pinDot.title = loc.name; 
                    pinsLayer.appendChild(pinDot);

                    // 3. Draw Label Bubble (Draggable)
                    const label = document.createElement('div');
                    label.className = 'absolute w-8 h-8 bg-black text-white rounded-full flex items-center justify-center font-bold text-sm label-bubble pointer-events-auto hover:bg-gray-800 select-none';
                    label.style.left = loc.labelX + 'px';
                    label.style.top = loc.labelY + 'px';
                    label.textContent = loc.letter;
                    
                    // Mouse events for dragging
                    label.onmousedown = (e) => this.startDrag(e, loc.id);
                    
                    pinsLayer.appendChild(label);
                });
            },

            startDrag(e, id) {
                e.preventDefault();
                this.draggedLabel = id;
            },

            handleDrag(e) {
                if (!this.draggedLabel) return;

                const container = document.getElementById('mapContainer');
                const rect = container.getBoundingClientRect();
                
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;

                // Boundary check
                x = Math.max(10, Math.min(x, rect.width - 10));
                y = Math.max(10, Math.min(y, rect.height - 10));

                // Update data
                const loc = this.locations.find(l => l.id === this.draggedLabel);
                if (loc) {
                    loc.labelX = x;
                    loc.labelY = y;
                    this.renderMapItems(); // Re-render instantly for smooth line update
                }
            },

            stopDrag() {
                this.draggedLabel = null;
            },

            getLetter(index) {
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                if (index < 26) return letters[index];
                const first = Math.floor(index / 26) - 1;
                const second = index % 26;
                return letters[first] + letters[second];
            },

            updateList() {
                const list = document.getElementById('locationList');
                const empty = document.getElementById('emptyState');
                const count = document.getElementById('pinCount');
                
                list.innerHTML = '';
                count.textContent = this.locations.length;

                if (this.locations.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    empty.classList.add('hidden');
                    this.locations.forEach(loc => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-50 p-2 rounded border border-gray-200 flex justify-between items-center group';
                        li.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 bg-gray-800 text-white text-xs font-bold rounded-full flex items-center justify-center">${loc.letter}</span>
                                <span class="font-medium text-gray-700 text-sm truncate w-32" title="${loc.name}">${loc.name}</span>
                            </div>
                            <button onclick="app.removeLocation(${loc.id})" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                        list.appendChild(li);
                    });
                }
            },

            removeLocation(id) {
                this.locations = this.locations.filter(l => l.id !== id);
                // Re-calculate letters
                this.locations.forEach((l, index) => {
                    l.letter = this.getLetter(index);
                });
                this.renderMapItems();
                this.updateList();
            },

            clearAll() {
                if(confirm('Remove all locations?')) {
                    this.locations = [];
                    this.nextId = 1;
                    this.renderMapItems();
                    this.updateList();
                }
            },

            toggleAnswerSheet() {
                const modal = document.getElementById('answerSheetModal');
                const content = document.getElementById('answerSheetContent');
                
                if (modal.classList.contains('hidden')) {
                    // Open
                    content.innerHTML = '';
                    this.locations.forEach(loc => {
                        content.innerHTML += `
                            <div class="flex items-center gap-3 border-b border-gray-100 pb-2">
                                <span class="text-xl font-bold text-blue-600 w-8">${loc.letter}</span>
                                <span class="text-lg text-gray-800">${loc.name}</span>
                            </div>
                        `;
                    });
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    // Close
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            },

            printAnswerKey() {
                // To print just the key, we need to manipulate the DOM slightly during print
                // or just rely on a text list.
                // Simple approach: create a temporary print window or just hide everything else
                // Let's use the Print stylesheet logic
                
                // Hide map, show list
                const printSheet = document.getElementById('printableAnswerLines');
                printSheet.innerHTML = '';
                // This function is for the KEY (answers filled in)
                
                const win = window.open('', '', 'width=800,height=600');
                win.document.write(`
                    <html>
                    <head>
                        <title>Answer Key</title>
                        <link href="https://cdn.tailwindcss.com" rel="stylesheet">
                        <style>body { font-family: sans-serif; padding: 40px; } </style>
                    </head>
                    <body>
                        <h1 class="text-3xl font-bold mb-6 border-b pb-4">Quiz Answer Key</h1>
                        <div class="grid grid-cols-2 gap-4">
                            ${this.locations.map(loc => `
                                <div class="flex items-center border-b border-gray-200 py-2">
                                    <span class="font-bold w-12 text-xl">${loc.letter}</span>
                                    <span class="text-lg">${loc.name}</span>
                                </div>
                            `).join('')}
                        </div>
                        <script>window.print();<\/script>
                    </body>
                    </html>
                `);
                win.document.close();
            },

            updateUI() {
                // Setup print view for Guest Sheet
                window.onbeforeprint = () => {
                   const sheet = document.getElementById('printableAnswerLines');
                   sheet.innerHTML = this.locations.map(loc => `
                        <div class="flex items-end border-b-2 border-gray-300 py-4">
                            <span class="font-bold text-2xl mr-4 w-8">${loc.letter}</span>
                            <div class="flex-1"></div>
                        </div>
                   `).join('');
                };
            }
        };

        // Initialize
        app.init();
        app.updateUI(); // Bind print events
    </script>
</body>
</html>
